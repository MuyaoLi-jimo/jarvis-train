from transformers import AutoProcessor,AutoModelForCausalLM,GenerationConfig



# load the processor
processor = AutoProcessor.from_pretrained(
    "/scratch/models/molmo-7b-d-0924",
    trust_remote_code=True,
    torch_dtype='auto',
    device_map='auto'
)

# load the model
model = AutoModelForCausalLM.from_pretrained(
    "/scratch/models/molmo-7b-d-0924",
    trust_remote_code=True,
    torch_dtype='auto',
    device_map='auto'
)

import requests
from PIL import Image

# process the image and text
image_path = "/home/limuyao/datas/jarvis-dataset-003/image/3d966b41-2299-4acd-b4b1-3fbbd7e653e47.jpg"

inputs = processor.process(
    images=[Image.open(image_path)],
    text="point at the cursor"
)

# move inputs to the correct device and make a batch of size 1
inputs = {k: v.to(model.device).unsqueeze(0) for k, v in inputs.items()}

# generate output; maximum 200 new tokens; stop generation when <|endoftext|> is generated
output = model.generate_from_batch(
    inputs,
    GenerationConfig(max_new_tokens=200, stop_strings="<|endoftext|>"),
    tokenizer=processor.tokenizer
)

# only get generated tokens; decode them to text
generated_tokens = output[0,inputs['input_ids'].size(1):]
generated_text = processor.tokenizer.decode(generated_tokens, skip_special_tokens=True)
print(generated_text)

from processor_wrapper import MolmoOutProcess
molmo_processor = MolmoOutProcess()
image = molmo_processor.point(image_path,generated_text)
import cv2
success = cv2.imwrite("temp.jpg", image)

tokens = processor.tokenizer.convert_ids_to_tokens(inputs["input_ids"][0])
count = 0
for token in tokens:
    if token == '<im_patch>':
        count+=1
print(count)

import ipdb
ipdb.set_trace()

"""
[[151643, 152064, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152067, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152067, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152067, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152067,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152067, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152067, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152067, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152067, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152067, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152067, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152067, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152067, 152065, 
         
         
         152064, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152067,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152067, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152067, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152067, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152067, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152067, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152067, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152067, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152067, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152067,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152067, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152067, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152067, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152067, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152067, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152067, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152067, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152067, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152067,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066, 152066,
         152066, 152067, 152065,   2657,     25,   1459,    518,    279,   8128,
          21388,     25
"""